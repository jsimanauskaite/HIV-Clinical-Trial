---
title: "Survival Analysis Project: HIV Clinical Trial"
author: "Juste Simanauskaite & Patricia Rivera"
geometry: margin=2cm
output: 
  pdf_document: 
    highlight: tango
    toc: true
    toc_depth: 6
    fig_width: 7
    fig_height: 6
    fig_crop: false

    
  html_document: default

---
# Introduction
  HIV (Human Immunodeficiency Virus) is a disease known as an immune system disorder, which causes severe destruction of white blood cells that are responsible for fighting infection. The presence of this disorder is a lead-in for a human to be more prone to infections and cancer diseases. AIDS is the final stage of HIV, which is not always developed in HIV patients. Zidovudine (AZT) is known as antiretroviral medication for prevention of HIV/AIDS, whereas lamuvidine (3TC) is an inhibitor medication that works in decreasing HIV and hepatitis B. Previously, it has been founded that three-drug combinations, in particular, with a previous exposure to AZT, have shown the most significant resulted in reducing HIV-1 RNA concentrations. Therefore, this study used indinavir sulfate (a synthetic antiviral agent that inhibits HIV protease activity) in combination with AZT and 3TC as well as variation of placebo treatments to determine the potency of triple drug therapy in the cases of  advanced HIV-1 patients. The study hypothesized that a three-drug combination, including a HIV-protease inhibitor and two nucleoside analogues (AZT and 3TC) would alter the progression of the HIV-1 disease. The study was successful in reaching significant data of the clinical superiority of a three-drug approach with inidavor over a treatment containing only a two-drug combination.
  
# Methods

The study was a randomized, double-blind, and a placebo-controlled trial that compared a three-drug treatment of indinavir (Crixivan), zidovudine (AZT) and lamivudine (3TC) with a two-drug treatment. A total of 1156 patients were selected based on the factor that they had no more than 200 CD4 cells per cubic millimetear at least 3 months prioir to AZT therapy. The patients had to be more than 16 years old, with a diagnostic documentation of HIV-1 infection, having no more than 1 week of prior lamuvidine treatment, and a Karnofsky score of at least 70.

The approved patients received 200mg of open-label zidovudine three times daily and 150mg of lamuvidine two times daily and were randomly assigned to a placebo or a treatment of 800mg of indinavir every eight hours.

Some modifications were made to the protocol. In October of 1996 prioir exposure to AZT was reduced to at least 3 months and permitted patients with no tolerance for this drug to enter the study with stavudine as a substitute.

Patients diagnosed with AIDS-defining events were offored an open-label assignment of the indinavir treatment with nor reveal of their initial treatment assignments. All of these cases had to be reviewed via a blind procedure by the study chair.

Follow ups were made at weeks 4,8, and 16 and every eight weeks afterwards. CD4 cell counts and Plasma HIV-1 RNA concentrations were measured twice at baseline and at weeks 4,8,24, and 40. 

The statistical analysis methods used to interpret results were Kaplan-Meier estimates, log-rank tests, and proportional hazards models. The p-values, estimates of treatment differences and 95% confidence intervals were not adjusted for repeated analysis.


```{r global_options, include=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, fig.height=3, fig.width=5, 
                      fig.align="center")
library(tidyverse)
library(broom)
library(plyr)
library(survival)
library(survminer)
library(coxed)


aids <- read.csv( "http://pages.pomona.edu/~jsh04747/courses/math150/AIDSdata.csv")
dim(aids)
summary(aids)

```

The data set contains a sample size equal to 851 participants and 16 different variables.

```{r}
library(plotrix)
male<-sum(aids$sex==1)
female<-sum(aids$sex==2)
slices <- c(male, female) 
lbls <- c("Male", "Female")
pct <- round(slices/sum(slices)*100)
lbls <- paste(lbls, pct) 
lbls <- paste(lbls,"%",sep="") 
pie3D(slices,labels=lbls,explode=0.1,
   main="Gender Distribution ", cex.lab=0.1)
```
The Pie Chart represents the gender distribution in the sample, with 84% male and 16% female. This shows the potential for the data to not be able to correctly represent the difference of the data variance by gender, if there were to be one. Therefore, gender is something to look into in future data analysis.
```{r}
wnh<-sum(aids$raceth==1)
bnh<-sum(aids$raceth==2)
h<-sum(aids$raceth==3)
api<-sum(aids$raceth==4)
aian<-sum(aids$raceth==5)
oth<-sum(aids$raceth==6)
slices <- c(wnh,bnh,h,api,aian,oth) 
lbls <- c("White Non-Hispanic", "Black Non-Hispanic", "Hispanic","Asian, Pacific Islander", 
          "American Indian, Alaskan Native", "Other/unknown")
pct <- round(slices/sum(slices)*100)
lbls <- paste(lbls, pct) 
lbls <- paste(lbls,"%",sep="") 
pie(slices,lbls,col = rainbow(length(lbls)), cex=0.5 )

```
The distribution of race/ethnicity shows that the greatest number of participants consists of white non-Hispanic identifying individuals, with black non-Hispanic following and Hispanic as the 3rd largest represented group.
```{r}
never<-sum(aids$ivdrug==1)
cur<-sum(aids$ivdrug==2)
prev<-sum(aids$ivdrug==3)
slices <- c(never,cur,prev) 
lbls <- c("Never", "Currently", "Previously")
pct <- round(slices/sum(slices)*100)
lbls <- paste(lbls, pct) 
lbls <- paste(lbls,"%",sep="") 
pie3D(slices,labels=lbls,explode=0.1,col=c("turquoise","magenta","salmon"),cex.sub=0.5,
   main="IV Drug Use History ")

```
From this chart we see that most of the participants (84%) have never used IV drugs, whereas 16% of participants have some type of history of usage and none of the participants reported to be currently using the drugs.

```{r}
hist(aids$time)

###Data Plots

fit <- survfit(Surv(time,censor)~tx, data = aids)
ggsurvplot(fit,data = aids,conf.int = FALSE)

aids_fit_time <- survfit(Surv(time, censor) ~ sex, data=aids)
ggsurvplot(aids_fit_time, data=aids,  conf.int = TRUE)

aids_fit_time.d <- survfit(Surv(time_d, censor_d) ~ sex, data=aids)
ggsurvplot(aids_fit_time.d, data=aids,  conf.int = TRUE)

```
#Survival Analysis 
```{r}
#mutation of age
aids <- read.csv( "http://pages.pomona.edu/~jsh04747/courses/math150/AIDSdata.csv")
aids <- aids %>% 
  mutate(age = ifelse(age <= 20, "under20", 
                             ifelse(age <=30, "20-30",
                                    ifelse(age <= 40, "30-40",
                                           ifelse(age <=50, "40-50",
                                                 ifelse(age <=60, "50-60",
                                                        ifelse(age <=70, "60-70", 
                                                               "over70"))))))) %>%
  mutate(age = factor(age,
                       levels = c("under20", "20-30", "30-40","40-50", "50-60","60-70","over70")),  
         sex = ifelse(sex == 2, "male","female"))
```
Since there are many values of the explanatory variable "age" in the original data, we've decided to mutate the variable into age categories from under 20 to over 70 in increments of 10 years. 
```{r}
library(survival)
library (survminer)
library(ggplot2)
library(broom)

##### backwards selection ######


#full model
cph_full<- coxph(Surv(time,censor)~.-time_d -censor_d, data = aids)
cph_full$loglik
cph_full

#reduced model 1
cph_r1 <- coxph(Surv(time,censor)~.-time_d -censor_d -priorzdv, data = aids) 
cph_r1$loglik
cph_r1

#likelihood ratio test
stat1<- 2*(cph_full$loglik[2]-cph_r1$loglik[2])
1-pchisq(stat1,1)

#reduced model 2
cph_r2 <- coxph(Surv(time,censor)~. -time_d -censor_d -priorzdv -id, data = aids)
cph_r2$loglik
cph_r2


#likelihood ratio test
stat2 <- 2*(cph_r1$loglik[2]-cph_r2$loglik[2])
1-pchisq(stat2,1)


#reduced model 3
cph_r3 <- coxph(Surv(time,censor)~.-time_d -censor_d -priorzdv -id -hemophil, data = aids)
cph_r3$loglik
cph_r3


#likelihood ratio test
stat3 <- 2*(cph_r3$loglik[2]-cph_r2$loglik[2])
1-pchisq(stat3,1)


#reduced model 4
cph_r4 <- coxph(Surv(time,censor)~.-time_d -censor_d -priorzdv -id -hemophil -raceth, data = aids)
cph_r4$loglik
cph_r4

#likelihood ratio test
stat4 <- 2*(cph_r3$loglik[2]-cph_r4$loglik[2])
1-pchisq(stat4,1)


#reduced model 5
cph_r5 <- coxph(Surv(time,censor)~.-time_d -censor_d -priorzdv -id -hemophil -raceth, data = aids)
cph_r5$loglik
cph_r5

#likelihood ratio test
stat5 <- 2*(cph_r5$loglik[2]-cph_r4$loglik[2])
1-pchisq(stat5,1)

#reduced model 6
cph_r6 <- coxph(Surv(time,censor)~.-time_d -censor_d -priorzdv -id -hemophil -raceth -strat2, data = aids)
cph_r6$loglik
cph_r6

#likelihood ratio test
stat6 <- 2*(cph_r5$loglik[2]-cph_r6$loglik[2])
1-pchisq(stat6,1)


#reduced model 7
cph_r7 <- coxph(Surv(time,censor)~.-time_d -censor_d -priorzdv -id -hemophil -raceth -strat2 -sex, data = aids)
cph_r7$loglik
cph_r7


#likelihood ratio test
stat7 <- 2*(cph_r6$loglik[2]-cph_r7$loglik[2])
1-pchisq(stat7,1)


#reduced model 8
cph_r8 <- coxph(Surv(time,censor)~.-time_d -censor_d -priorzdv -id -hemophil -raceth -strat2 -sex -txgrp -age, data = aids)
cph_r8$loglik
cph_r8

#likelihood ratio test
stat8 <- 2*(cph_r7$loglik[2]-cph_r8$loglik[2])
1-pchisq(stat8,1)


#reduced model 9
cph_r9 <- coxph(Surv(time,censor)~.-time_d -censor_d -priorzdv -id -hemophil -raceth -strat2 -sex -txgrp -age -tx, data = aids)
cph_r9$loglik
cph_r9


###best model using backwards selection?
#likelihood ratio test
stat9 <- 2*(cph_r8$loglik[2]-cph_r9$loglik[2])
1-pchisq(stat9,1)

#reduced model 10
cph_r10 <- coxph(Surv(time,censor)~.-priorzdv -id -hemophil -raceth -time_d -strat2 -sex -txgrp -age -tx -censor_d, data = aids)
cph_r10$loglik
cph_r10


#NOTE: should we take out censor_d anyways since its related to censor or keep it?
#likelihood ratio test
stat10 <- 2*(cph_r9$loglik[2]-cph_r10$loglik[2])
1-pchisq(stat10,1)

cph_r11 <- coxph(Surv(time,censor)~.-priorzdv -id -hemophil -raceth -time_d -strat2 -sex -txgrp -age -tx -censor_d -ivdrug, data = aids)
cph_r11$loglik
cph_r11

stat11 <- 2*(cph_r10$loglik[2]-cph_r11$loglik[2])
1-pchisq(stat11,1)
```

```{r}
coxph(Surv(time_d,censor_d) ~ sex , data=aids)  %>% tidy()
coxph(Surv(time,censor) ~ sex, data=aids) %>% tidy()

coxph(Surv(time,censor) ~ age+ txgrp+ karnof, data=aids) %>% tidy()
cox.zph(coxph(Surv(time,censor) ~ age + txgrp+karnof, data=aids))
coxph(Surv(time,censor) ~ age *txgrp*karnof, data=aids) %>% tidy()
cox.zph(coxph(Surv(time,censor) ~ age *txgrp*karnof, data=aids))

ggsurvplot(survfit(Surv(time,censor) ~ 1, data=aids), 
           censor=F, conf.int=T, fun="cumhaz") + ggtitle("Estimated Hazard rates")


ggsurvplot(survfit(Surv(time,censor) ~ sex, data=aids), 
           censor=F, conf.int=T, fun="cumhaz") + 
  ggtitle("Estimated Hazard rates based on sex")
ggsurvplot(survfit(Surv(time,censor) ~ txgrp, data=aids), 
           censor=F, conf.int=T, fun="cumhaz") + 
  ggtitle("Estimated Hazard rates based on treatment group")

ggsurvplot(survfit(Surv(time,censor) ~ karnof, data=aids), 
           censor=F, conf.int=T, fun="cumhaz") + 
  ggtitle("Estimated Hazard rates based on klarnfsky")

ggsurvplot(survfit(Surv(time,censor) ~ age, data=aids), 
           censor=F, conf.int=T, fun="cumhaz") + 
  ggtitle("Estimated Hazard rates based on age")


ggsurvplot(survfit(Surv(time, censor)~hemophil, data = aids),
           censor=F, conf.int = T, fun = "cumhaz")


ggsurvplot(survfit(Surv(time, censor)~ivdrug, data = aids),
           censor=F, conf.int = T, fun = "cumhaz")


coxph(Surv(time,censor) ~ ivdrug, data=aids) %>% tidy()

coxph(Surv(time,censor) ~ ivdrug*karnof, data=aids) %>% tidy()



coxph(Surv(time,censor)~sex+tx+age+txgrp, data = aids) %>% tidy()

```

```{r}

library(ggfortify)

aa_fit <-aareg(Surv(time, censor) ~ txgrp + sex + ivdrug + hemophil + karnof, 
                 data = aids)
autoplot(aa_fit)
```

The Aalen model assumes that the cumulative hazard $H(t)$ for a subject can be expressed as $a(t)$ + X $B(t)$, where $a(t)$ is a time-dependent intercept term, X is the vector of covariates for the subject possibly time-dependent, and $B(t)$ is a time-dependent matrix of coefficients.

The plots show how the effects of the covariates change over time. 


#Patricia's "Something New"
I will be doing a power analysis by simulating survival analysis curves

### 1. What is the topic?
The topic is using sim.survdata in R to simulate survival data. Using that simulated data, we will make that the alternative and control for the coefficient beta by setting it equal to some value. Then using power analysis, we will see how many times we reject $H_0$. 

### 2. How it is relevant? How it relates to survival analysis/analysis at hand?
Power analysis relates to survival analysis because if power is large after comparing our data to the simulated survival data, this tells us that there is a high chance that we would reject the null in favor of the alternative (control versus treatment?)

### 3. Resources to learn about the topic.
Below are some of the resources I have begun to use to learn about creating simulations of survival curves and performing power analysis:

a). https://cran.r-project.org/web/packages/coxed/vignettes/simulating_survival_data.html
b). http://www.icssc.org/documents/advbiosgoa/tab%2026.00_survss.pdf

### 4. What will be challenging about learning something new?
Learning something new will be challenging because in this case, the concept of power analysis is something I just recently learned in Intro to Statistics. So learning to apply this concept in the context of survival analysis curves will be a challenge for me to learn. Learning how to simulate survival curves will also be challenging because I will have to learn how to use and interpret new functions in R.

### Power Analysis code and simulation
```{r}
simdata <- sim.survdata(N=1000, T=100, num.data.frames=1, beta = c(0.01,0.07,0.3))
head(simdata$data,10)
simdata$betas
head(simdata$baseline,10)


#ggsurvplot(survfit(Surv(y,failed) ~ X1 + X2 + X3, data = simdata$data))
model <- coxph(Surv(y, failed) ~ X1 + X2 + X3, data = simdata$data)

library(dplyr)
library(broom)
model %>% tidy()

set.seed(1234)
n.reps <- 100
simoutput <- c()
for(i in 1:n.reps){
  simdata <- sim.survdata(N=851, T=100, num.data.frames=1, xvars=2,beta = c(-0.058666,-0.015140))
  model <- coxph(Surv(y, failed) ~ X1 + X2, data = simdata$data)
  simoutput <- rbind(simoutput, cbind(rep = rep(i, 2), model %>% tidy()))
  
}

simoutput

#sum(which(simoutput$p.value < 0.05))
sum(simoutput$p.value <0.05)

#simoutput%>%filter(term=="X1")%>%summarize(sum(p.value<0.05))

simoutput%>%dplyr::filter(term=="X1")%>%dplyr::summarize(sum(p.value<0.05))

simoutput%>%dplyr::filter(term=="X2")%>%dplyr::summarize(sum(p.value<0.05))

simoutput%>%dplyr::filter(term=="X3")%>%dplyr::summarize(sum(p.value<0.05))

simoutput%>%dplyr::filter(term=="X4")%>%dplyr::summarize(sum(p.value<0.05))
```



# Juste's "Something New"
I will be analyzing the Shoenfeld residuals for the Cox PH model.

### 1. What is goign on? What is the topic? 2. How it is relevant? How it relates to survival analysis/analysis at hand?

Cox proportional hazards (PH) model is considered a great way to identify combined effects of several covariates on the relative risk (hazard). This model assumes that the hazards of the different strata formed by the levels of the covariates are proportional. This proportional hazards assumption is particularly important and can be tested via three different classes of tests. The first class is focused on the piece-wise estimation of models for subsets of data defined by stratification of time. The second one considers the interactions between covariates and some function of time. Final, third one is based on examinations of regression residuals. The Schoenfeld Residuals are a part of the third class of proportional hazard assumption testing and I will be exploring it in order to be able to eradicate a method for testing for the PH assumption in the current and future data set analyses. This topic is particularly important in relation to survival analysis since it provides an idea of whether the model is appropriate for the data set at hand and whether some covariates should be considered as variants of time in order to supply the best model for prediction of proportional hazards.

### 3. Resources to learn about the topic.

I have been researching articles and scientific journals that provide insights into the Schoenfeld residuals and their use in the Cox PH model. 
Sources include: 

1. https://onlinelibrary.wiley.com/doi/full/10.1111/ajps.12176
2. https://rstudio-pubs-static.s3.amazonaws.com/39354_34153ff19e624116bd2fbdec7d2534aa.html 

### 4. What will be challenging about learning something new?

Taking a completely new model of analyzing survival data is particularly difficult since the mathematical derivations and notations are also very varied from what we have seen in class. Although, I do remember some of the ideas behind parametric functions, their applications to statistical models are much more challenging than I have expected. Therefore, it will require me a lot of time and extensive research to be able to understand and learn how to apply this model to our data and other instances of survival analysis.

### Explanation of the Theory Behind Schoenfeld Residuals

Let $z_{ij}(t)$ be the $j^{th}$ covariate of the $i^{th}$ unit, where $i=1,2,...,n$ and $j=1,2...,p$

This notation indicates that $z_{ij}$ is allowed to vary as a function of the time scale.

1) As we know from lecture, the Cox PH model assumes that $h(t)$ of the $i^{th}$ individual satisfies: 

* $h_i(t)=h_0(t)e^{z_i(t)\beta}$ where: 
  + $h_0$ -> baseline hazard
  + $z_i(t)$ -> 1 x $p$ vector of covariates for unit $i$ each of which can be time fixed or time-varying.

2) However, another possibility has been presented by Therneau and Granbsh in 2000, where they proposed an idea that there could be an alternative to the current Cox model, where the coefficient of the estimate could also be varying as a function of time.

> The new hazard function would look like this: $h_i(t)=h_0(t)e^{z_i(t)\beta(t)}$

Therefore, in order to examine thee two models in a case when $\beta=\beta(t)$ requires a residual analysis that could indicate whether a model should consider a covariate as a variable with time.

***
Due to the fact that that some observations might be censored and in particular, regarding the Cox PH model, the baseline hazard is not estimated, in order to analyse the residuals a particular score process. The risk score for unit $i$ at time $t$ is thought to be $r_i(t)=e^{z_i(t)\beta}$, where $Y_i(t)$ is the indicator function and $Y_i(t)=1$ indicates a point in which $i$ is under risk and thus observation and it is equal to 0 in other occasions.

***

The Schoenfeld residuals are given by the equations:

1. $s_k=Z_{(k)}-\frac{\sum_iY_i(t_k)r_i(t_k)Z_i(t_k)}{\sum_iY_i(t_k)r_i(t_k)}$
2. $s_k=Z_{(k)}-\bar{z}(\hat{\beta},t_k)$

In this case, the $Z(k)$ is the covariate vector of the particular unit that is experiencing the event at time $k$; $\hat{\beta}$ is the estimate of $\beta$ and $\bar{z}(\hat{\beta},t_k)$ is the weighted mean of covariate values.

Furthermore, the weighted variance can be represented by the derived equation at the $k^{th}$ time as

$V(\beta,t_k)=\sum_iY_i(t_k)r_i(t_k)Z_i(t_k)-\bar{z}(\hat{\beta},t_k)'Z_i(t_k)-\frac{\bar{z}(\hat{\beta},t_k)}{\sum_iY_i(t_k)r_i(t_k)}$

From this, we can scale the Schoenfeld residuals by $V(\beta,t_k)$ of X at $t_k$ via the equation:

$s^*_k=V^{-1}(\hat{\beta},t_k)s_k$

The scaled Schoenfeld residuals can also be defined as follows:

$s^*_k=m\sum^d_{k=1}V(\hat{\beta},t_k)s_k$

here, $m$ is the total number of deaths in the data set.

Following the calculations, the residuals are plotted against time in order to test the proportional hazards assumption. If the assumption is correct, the residuals should be fitting around the line centered at zero (y=0). The further away this predicted line is form the horizontal of (y=0) the more likely one is to call the PH assumption to question and determine whether it is met through the model.

***
> To go a little deeper into the analysis of the resiaul calculation, one can look at the calculations of the test statistic for this residual mdoel.

By producing a least squares slope of regression and assuming a relationship between $s^*_{kj}$ and $t_{kj}$ or some function $g(t_k)$ allows to derive a test statistic for the proportional hazards assumption in regards to the $j^{th}$ covariate, which is given by:

$T_j=\frac{[\sum^d_{k=1}(g(t_k)-\hat{g})s^8_{kj}]^2}{dI^{jj}\sum^d_{k=1}(g(t_k)-\hat{g})^2}$

Here, the distribution is asymptotically as $X^2(1)$ stating the null hypothesis that the relationship between the covariate, in this case $j$ and the event time follows the assumption of PH.

***

> Interpretation of Schoenfeld Residuals from plots in R and the p-values presented.

The y-axis of the Schoenfeld residuals graph can be interpreted as the log of the hazard ratio for the explanatory variable-- the coefficient in Coxâ€™s model if it were allow to vary over time. If the graph is flat, then the PH assumption is adequate. Furthermore, the Schoenfeld residuals are independent of time. A plot that shows a non-random pattern against time is evidence of violation of the PH assumption. The PH assumption is supported when there's a non-significant relationship between residuals and time.
### HIV Data Cox PH model analysis using Schoenfeld Residuals

Schoenfeld Residuals applied to our best Cox PH model for AIDS data where, we have an additive model of explanatory variables: baseline CD4 count, iv drug use history, and karnofsky performance scale score:
```{r}
cph_r10 <- coxph(Surv(time,censor)~.-priorzdv -id -hemophil -raceth -time_d -strat2 
                 -sex -txgrp -age -tx -censor_d, data = aids)
cph_r10
zph_r10 <- cox.zph(cph_r10)
zph_r10
ggcoxzph(zph_r10)
ggcoxdiagnostics(cph_r10, type="schoenfeld")

```

Using the best determined Cox PH model for our data, we can look at the Schoenfeld residuals to determine if the PH assumption is met. Via the function "ggcoxzph()"", which produces, for each covariate, graphs of the scaled Schoenfeld residuals against the transformed time. Here, the solid line is a smoothing spline fit to the plot, with the dashed lines representing a +/- 2-standard-error. from these graphs, we don't see any patterns or significance of the residual fit regarding the graphs of the covariates with time. Therefore, the assumption of proportional hazards seems to be supported for the covariates: baseline CD4 count, iv drug use history, and karnofsky performance scale score.

Using the ggcoxdiagnostics() function we can provide another graphic representation of the residual distribution in regards to the covariates with time. Here, we also see that there's no particular pattern of the residuals around the line of fit, therefore again, we can state that the PH assumption has been met.


